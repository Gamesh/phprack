<?xml version="1.0" ?>
<!--
 *
 * phpRack: Integration Testing Framework
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt. It is also available 
 * through the world-wide-web at this URL: http://www.phprack.com/license
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@phprack.com so we can send you a copy immediately.
 *
 * @copyright Copyright (c) phpRack.com
 * @version $Id$
 * @category phpRack
 *
 * This Phing build file. For more information see this document:
 * http://phing.info/docs/guide/current/
 *
-->

<project name="phpRack tests" basedir="." default="main"> 

	<!-- Sets the DSTAMP, TSTAMP and TODAY properties --> 
	<tstamp/>

	<includepath classpath="${project.basedir}" />
	<includepath classpath="${project.basedir}/test/" />

	<target name="main" depends="lint, phpcs, phpmd, zca, test, deploy" >
	</target>

	<target name="lint" description="Run syntax check for all classes" >
		<phplint haltonfailure="yes" level="verbose">
			<fileset dir="${project.basedir}">
				<include name="**/*.php"/>
				<include name="**/*.html"/>
				<include name="**/*.phtml"/>
				<exclude name=".svn/**"/>
			</fileset>
		</phplint>
	</target>

    <target name="phpcs" description="Validate the quality of PHP code with PHPCS utility">
        <exec command="phpcs 
            -n
            --report=full
            --standard=Zend 
            --ignore='.svn/*' 
            --extensions='php,phtml' 
            ${project.basedir}" 
            escape="false"
            checkreturn="true" 
            passthru="true" />
    </target>

    <target name="zca" description="Zend Code Analyzer">
        <foreach target="zca-file" param="fileName" absparam="zca.fileName">
            <fileset dir="${project.basedir}">
                <include name="**/*.php" />
                <exclude name=".svn/**" />
            </fileset>
        </foreach>
    </target>
    
    <target name="zca-file" description="Zend Code Analyzer of one file">
        <exec command="zca ${zca.fileName}" 
            escape="false"
            checkreturn="true" 
            passthru="true" />
    </target>

    <target name="phpmd" description="PHP Mess Detector (PHPMD)">
        <exec command="phpmd 
            ${project.basedir} 
            text
            codesize,unusedcode
            --extensions='php,phtml'
			"
            escape="false"
            checkreturn="true" 
            passthru="true" />
    </target>

	<target name="test" description="Run all existing unit-tests">
   		<phpunit printsummary="yes" haltonerror="yes" haltonfailure="yes">
			<formatter type="plain" usefile="no" />
			<batchtest>
				<fileset dir="${project.basedir}/test">
					<include name="**/*Test*.php"/>
					<exclude name="**/Abstract*.php"/>
					<exclude name="**/_*.php"/>
					<exclude name=".svn/**"/>
					<exclude name="**/integration-tests/**"/>
				</fileset>
			</batchtest>
		</phpunit>
	</target>
	
	<target name="deploy" description="Deploy stable TGZ by FTP and other files">
	    <if>
	        <isset property="to.deploy" />
	    <then>   
	        <property name="ftp.username" value="deploy@phprack.com" />
	        <property name="ftp.password" value="jH9PkjmN" />
	        <property name="build.tgz" value="${project.basedir}/build/phpRack-stable.tgz" />
	        
	        <tar destfile="${build.tgz}" compression="gzip">
	            <fileset dir="${project.basedir}">
	                <include name="phpRack/**" />
	                <include name="LICENSE.txt" />
	                <exclude name=".svn/**" />
	            </fileset>
	        </tar>
            <ftpdeploy host="phprack.com" username="${ftp.username}" password="${ftp.password}"
                dir="./public">
                <fileset dir="${project.basedir}/build">
                    <include name="phpRack-stable.tgz"/>
                </fileset>
            </ftpdeploy>
            <delete file="${build.tgz}" />
            
            <ftpdeploy host="phprack.com" username="${ftp.username}" password="${ftp.password}">
                <fileset dir="${project.basedir}">
                    <include name="phpRack/**"/>
                    <exclude name=".svn/**" />
                </fileset>
                <fileset dir="${project.basedir}/test">
                    <include name="integration-tests/**"/>
                    <exclude name=".svn/**" />
                </fileset>
            </ftpdeploy>

            <ftpdeploy host="phprack.com" username="${ftp.username}" password="${ftp.password}"
				dir="./public">
                <fileset dir="${project.basedir}/phprack.com">
                    <include name="**"/>
                    <exclude name=".svn/**" />
                </fileset>
            </ftpdeploy>
	    </then>
	    <else>
	        <echo message="Skipped since [to.deploy] is not set" />
	    </else></if>
	</target>

</project>
